DECLARE @FORM_INST_ID	VARCHAR(100)
DECLARE @BODY_CONTEXT	XML

DECLARE CUR CURSOR FOR
SELECT FORM_INST_ID,CONVERT(XML,BODY_CONTEXT) FROM COVI_FLOW_FORM_INST..WF_FORM_INSTANCE_WF_AM_042__V100
OPEN CUR
FETCH NEXT FROM CUR INTO @FORM_INST_ID,@BODY_CONTEXT
WHILE @@FETCH_STATUS=0
BEGIN
	--결재상태,최종 결재 일자 Start--------------------------------------
	DECLARE @STATE VARCHAR(100)
	DECLARE @FINAL_COMP_DATE VARCHAR(100)
	DECLARE @DOMAIN_DATA_CONTEXT XML
	CREATE TABLE #TEMP_TABLE (
	    STATUS VARCHAR(100),
	    DATE_COMPLETED VARCHAR(100)
	)
	SELECT @DOMAIN_DATA_CONTEXT=DOMAIN_DATA_CONTEXT FROM COVI_FLOW_INST..WF_DOMAIN_DATA WHERE PROCESS_ID=(SELECT  ROOT_PROCESS_ID FROM  COVI_FLOW_FORM_INST..WF_FORM_INFORMATION WHERE FORM_INST_ID=@FORM_INST_ID)
	DECLARE @ApvLineHandle INT
	EXEC sp_xml_preparedocument @ApvLineHandle OUTPUT, @DOMAIN_DATA_CONTEXT;
	INSERT INTO #TEMP_TABLE
	SELECT 
	      STATUS
		 ,DATE_COMPLETED
	FROM 
	OPENXML(@ApvLineHandle, '/steps/division/step/ou/person/taskinfo',2)
	WITH (
		 STATUS			VARCHAR(100)	'@status',
		 DATE_COMPLETED	VARCHAR(100)	'@datecompleted'
	)
	EXEC sp_xml_removedocument @ApvLineHandle;
	
	IF (SELECT COUNT(1) FROM #TEMP_TABLE WHERE STATUS IN('rejected','inactive','pending'))=0
	BEGIN
		SELECT @STATE='COMPLETE',@FINAL_COMP_DATE=MAX(DATE_COMPLETED) FROM #TEMP_TABLE
	END 
	ELSE IF (SELECT COUNT(1) FROM #TEMP_TABLE WHERE STATUS='rejected')>0
	BEGIN
		SET @STATE='REJECT'
		SET @FINAL_COMP_DATE=NULL
	END
	ELSE
	BEGIN
		SET @STATE='APPROVAL'
		SET @FINAL_COMP_DATE=NULL
	END
	DROP TABLE #TEMP_TABLE
	--결재상태,최종 결재 일자 End----------------------------------------
	PRINT @FORM_INST_ID

	DECLARE @XmlDocumentHandle INT
	EXEC sp_xml_preparedocument @XmlDocumentHandle OUTPUT, @BODY_CONTEXT
	MERGE COVI_FLOW_SI_WX..TB_AM_ADDBOX_IDLE AS T
	USING
	(
		 SELECT 
		 @FORM_INST_ID AS FORM_INST_ID
		,@STATE AS [STATE]
		,@FINAL_COMP_DATE AS FINAL_COMP_DATE
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/INITIATOR_OU_DP)[1]','NVARCHAR(100)') AS INITIATOR_OU_DP
		,COVI_SMART.dbo.Fn_ComSplit_S(@BODY_CONTEXT.value('(/BODY_CONTEXT/INITIATOR_DP)[1]','NVARCHAR(100)'), '/',1) AS INITIATOR_DP
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/hdnRqstSabun)[1]','NVARCHAR(50)') AS RQST_SABUN
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/hdnTelephone)[1]','NVARCHAR(50)') AS TELEPHONE
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/hdnRqstUserName)[1]','NVARCHAR(1000)') AS RQST_USER_NAME
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/INITIATED_DATE_DP)[1]','NVARCHAR(100)') AS INITIATED_DATE_DP
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/hiddvBizPlaceBefore_Value)[1]','NVARCHAR(50)') AS BIZ_PLACE_BEFORE_VALUE
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/hiddvBizPlaceBefore_Text)[1]','NVARCHAR(100)') AS BIZ_PLACE_BEFORE_TEXT
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/hiddvBizPlaceAfter_Value)[1]','NVARCHAR(50)') AS BIZ_PLACE_AFTER_VALUE
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/hiddvBizPlaceAfter_Text)[1]','NVARCHAR(100)') AS BIZ_PLACE_AFTER_TEXT
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/RDO_location)[1]','NVARCHAR(50)') AS [LOCATION]
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/txtReason)[1]','NVARCHAR(1000)') AS REASON
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/dayDDate)[1]','NVARCHAR(50)') AS DAY_D_DATE
		,@BODY_CONTEXT.value('(/BODY_CONTEXT/inoutType_val)[1]','NVARCHAR(50)') AS INOUTTYPE_VAL
		--,@BODY_CONTEXT.value('(/BODY_CONTEXT/hidPumpChillerConfirm)[1]','VARCHAR(50)') PUMP_CHILLER_CONFIRM
		, 'N' AS PUMP_CHILLER_CONFIRM
		,* FROM 
		OPENXML(@XmlDocumentHandle, '/BODY_CONTEXT/tblCapitalInfo',2)
		WITH (
			 NUM				INT				'ROWSEQ'
			,ASSET_MAIN			NVARCHAR(100)	'rMainAssetNo'
			,ASSET_SUB			NVARCHAR(100)	'rSubAssetNo'
			,MATERIAL_NO		NVARCHAR(50)		'rMaterialNo'
			,QTY				NVARCHAR(50)		'rQuantity'
			,UNIT				NVARCHAR(50)		'rUnit'
			,MAKER				NVARCHAR(100)	'rMaker'
			,MODEL				NVARCHAR(100)	'rModel'
			,SN					NVARCHAR(100)	'rSN'
			,PRODUCT_NAME		NVARCHAR(100)	'rProductName'
			,CC_BEFORE			NVARCHAR(100)	'rCC_Before'
			,CHARGER			NVARCHAR(50)		'rCharger'
			,CC					NVARCHAR(100)	'rCC'
			,BUILDING			NVARCHAR(50)		'rBuilding'
			,BUILDING_TEXT		NVARCHAR(100)	'rBuilding_text'
			,MACHINE_ID			NVARCHAR(50)		'rMachineID'
		)
	) AS S
	ON
	(
		T.FORM_INST_ID=S.FORM_INST_ID 
		AND T.ASSET_MAIN=S.ASSET_MAIN
		AND T.ASSET_SUB=S.ASSET_SUB
	)
	WHEN MATCHED THEN
		UPDATE SET 
		 T.[STATE] = S.[STATE]
		,T.FORM_PREFIX = 'WF_AM_042'
		,T.MATERIAL_NO = S.MATERIAL_NO
		,T.QTY = S.QTY
		,T.UNIT = S.UNIT
		,T.MAKER = S.MAKER
		,T.MODEL = S.MODEL
		,T.SN = S.SN
		,T.PRODUCT_NAME = S.PRODUCT_NAME
		,T.CC_BEFORE = S.CC_BEFORE
		,T.CHARGER = S.CHARGER
		,T.CC = S.CC
		,T.BUILDING = S.BUILDING
		,T.BUILDING_TEXT = S.BUILDING_TEXT
		,T.MACHINE_ID = S.MACHINE_ID
		,T.INITIATOR_OU_DP = S.INITIATOR_OU_DP
		,T.INITIATOR_DP = S.INITIATOR_DP
		,T.RQST_SABUN = S.RQST_SABUN
		,T.TELEPHONE = S.TELEPHONE
		,T.RQST_USER_NAME = S.RQST_USER_NAME
		,T.INITIATED_DATE_DP = S.INITIATED_DATE_DP
		,T.BIZ_PLACE_BEFORE_VALUE = S.BIZ_PLACE_BEFORE_VALUE
		,T.BIZ_PLACE_BEFORE_TEXT = S.BIZ_PLACE_BEFORE_TEXT
		,T.BIZ_PLACE_AFTER_VALUE = S.BIZ_PLACE_AFTER_VALUE
		,T.BIZ_PLACE_AFTER_TEXT = S.BIZ_PLACE_AFTER_TEXT
		,T.[LOCATION] = S.[LOCATION]
		,T.REASON = S.REASON
		,T.DAY_D_DATE = S.DAY_D_DATE
		,T.INOUTTYPE_VAL = S.INOUTTYPE_VAL
		,T.PUMP_CHILLER_CONFIRM = S.PUMP_CHILLER_CONFIRM
		,T.FINAL_COMP_DATE = S.FINAL_COMP_DATE
	WHEN NOT MATCHED BY TARGET THEN
		INSERT(
		 FORM_INST_ID
		,ASSET_MAIN
		,ASSET_SUB
		,[STATE]
		,FORM_PREFIX
		,MATERIAL_NO
		,QTY
		,UNIT
		,MAKER
		,MODEL
		,SN
		,PRODUCT_NAME
		,CC_BEFORE
		,CHARGER
		,CC
		,BUILDING
		,BUILDING_TEXT
		,MACHINE_ID
		,INITIATOR_OU_DP
		,INITIATOR_DP
		,RQST_SABUN
		,TELEPHONE
		,RQST_USER_NAME
		,INITIATED_DATE_DP
		,BIZ_PLACE_BEFORE_VALUE
		,BIZ_PLACE_BEFORE_TEXT
		,BIZ_PLACE_AFTER_VALUE
		,BIZ_PLACE_AFTER_TEXT
		,[LOCATION]
		,REASON
		,DAY_D_DATE
		,INOUTTYPE_VAL
		,PUMP_CHILLER_CONFIRM
		,FINAL_COMP_DATE
		,INSERT_DATE
		)VALUES(
		 S.FORM_INST_ID
		,S.ASSET_MAIN
		,S.ASSET_SUB
		,S.[STATE]
		,'WF_AM_042'
		,S.MATERIAL_NO
		,S.QTY
		,S.UNIT
		,S.MAKER
		,S.MODEL
		,S.SN
		,S.PRODUCT_NAME
		,S.CC_BEFORE
		,S.CHARGER
		,S.CC
		,S.BUILDING
		,S.BUILDING_TEXT
		,S.MACHINE_ID
		,S.INITIATOR_OU_DP
		,S.INITIATOR_DP
		,S.RQST_SABUN
		,S.TELEPHONE
		,S.RQST_USER_NAME
		,S.INITIATED_DATE_DP
		,S.BIZ_PLACE_BEFORE_VALUE
		,S.BIZ_PLACE_BEFORE_TEXT
		,S.BIZ_PLACE_AFTER_VALUE
		,S.BIZ_PLACE_AFTER_TEXT
		,S.[LOCATION]
		,S.REASON
		,S.DAY_D_DATE
		,S.INOUTTYPE_VAL
		,S.PUMP_CHILLER_CONFIRM
		,S.FINAL_COMP_DATE
		,GETDATE()
		);

	EXEC sp_xml_removedocument @XmlDocumentHandle


	FETCH NEXT FROM CUR INTO @FORM_INST_ID,@BODY_CONTEXT
END
CLOSE CUR
DEALLOCATE CUR
